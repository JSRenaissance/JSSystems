<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link type="text/css" rel="stylesheet" href="./style.css">
    <title>JSYSTEMSII</title>
    <style>@import url(https://fonts.googleapis.com/css?family=Quicksand:400,700,400italic,700italic);
        /*********************************************
         * HEADERS
        **********************************************/
        h1,h2,h3,h4,h5,h6 {
          margin: 0 0 20px 0;
          color: #333333;
          font-family: "Quicksand", sans-serif;
          line-height: 0.9em;
          letter-spacing: -0.08em;
          text-transform: uppercase;
          text-shadow: 0px; }

        .title{ text-shadow: 3px 3px 5px rgba(150, 150, 150, 1); }
    </style>

    <style>
    /*Responsive Web Design*/
    @media screen and (min-width: 768px) /* MEDIA-QUERY: DESKTOP - 768 AND WIDER */
    {   
        #chart {top: 80px;}
    }
    @media screen and (max-width: 767px) /* MEDIA-QUERY: TABLET-LANDSCAPE - SMALLER THAN 768 WIDE */
    {
        .nytg-navigation li {float: none;}
        #chart {top: 200px;}
    }
    @media screen and (max-width: 520px) /* MEDIA-QUERY: TABLET-PORTRAIT - SMALLER THAN 520 WIDE */
    {
    }
    @media screen and (max-width: 350px) /* MEDIA-QUERY: MOBILE - SMALLER THAN 320 WIDE */
    {
        .instructions{display: none;}
    }


    </style>

</head>
<body style="height:900px; width:1280px; overflow:auto">

<div style="position:absolute; left:20px; top:12px;">
    <a href="http://www.adaptivepatterns.net">
        <img src="./img/jsicon1.jpeg" height="80px" style="border-radius:13px; padding:3px; border:1px lightgrey solid;">
    </a>
</div>

<div class="nytg-navBar" style="left:0px; top:110px; padding-top:0px; margin-right:0px;">
    <ul class="nytg-navigation clearfix" style="list-style-type:none; padding-left:13px;">
        <li id="buttonA" class="selected">Web2.0</li>
        <li id="buttonB">CambrianExplosion</li>
        <li id="buttonC">PlatformWars</li>
        <li id="buttonD">The Great Transmigration</li>
        <li id="buttonE">ZombieApocalypse</li>
    </ul>
</div>

<div class="title" style="position:absolute; left:100px; top:75px;">
    <h3>Systems</h3>
</div>

<div id="footer" style="position:absolute; right:25px; top:0px;">
    <div class="hint" style="padding-top:6px;">
        JS Systems II reads like a hollywood epic.<br>
        Web 2.0 erupts into Explosion,<br>
        Two Wars, Transmigration,<br>
        and a Zombie Apocalypse.
        <section class="instructions" style="margin-top:10px;">
            <i>* Click button for <i>time period.</i><br>
            <i>* Click circle for <i> subsystem</i>.<br>
        </section>
    </div>
</div>

<div id="chart" style="position: absolute; height:800; padding-top:60px;">

<div id="toolTip" class="tooltip" style="opacity:0;">
    <div id="head" class="header"></div>
    <div id="header1" class="header1"></div>
    <div id="header2" class="header2"></div>
    <div style="position:absolute; left:10px">
        <div id="divOne" style="width:135px; left:0px; top:10px; position: absolute;" class="selected">
            <div class="header3"><br>PERSON</div>
            <div class="header-rule"></div>
            <div id="columnOne" class="header4"></div>
        </div>
        <div id="divTwo" style="width:125px; left:140px; top:10px; position: absolute;">
            <div class="header3"><br>COMPANY</div>
            <div class="header-rule"></div>
            <div id="columnTwo" class="header4"></div>
        </div>
        <div id="divThree" style="width:125px; left:272px; top:10px; position: absolute;">
            <div class="header3"><br>FACT</div>
            <div class="header-rule"></div>
            <div id="columnThree" class="header4"></div>
        </div>
    </div>
    <div  class="tooltipTail"></div>

</div>

<footer style="position:absolute; bottom:0px; left:0px; right:0px; width=100%;">
<div id="d3ref" style="text-align=center; width=100%;">made in d3</div>
<!--div id="d3ref" style="position:absolute; bottom:10px; left:175px;">stay tuned for JSSystems III.</div>
<div id="twitterref" style="position:absolute; bottom:10px; left:15px;">-send corrections to github-</div>
<div id="twitterref" style="position:absolute; bottom:10px; left:15px;">@adaptivepattern</div-->
</footer>

<script type="text/javascript" src="./d3.min.js"></script>
<script type="text/javascript">
/*
http://opensource.org/licenses/BSD-3-Clause
Copyright (c) 2014, Nash Systems
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

3. Neither the name of the <ORGANIZATION> nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/
    var m = [20, 120, 20, 120],
            w = 1280 - m[1] - m[3],
            h = 700 - m[0] - m[2],
            i = 0,
            root = {};

    var topicOne=""

    var fieldOne="columnDataOne";
    //var fieldTwo="columnDataOne";
    //var dataFields=["DataOne","TEST","DataTwo","DataThree"];
    var dataFields=["DataOne","DataTwo","DataThree","DataFour","DataFive","DataSix"];
    var sourceFields=["Category","Level1","Level2","Level3","Level4"];

    var colors = ["#D5252F", "#F47337", "#B02D5D", "#9B2C67", "#982B9A", "#692DA7", "#5725AA", "#4823AF", "#E96B38"];



    var tree = d3.layout.tree();

          tree.children(function (d) { 
            return d.values; 
          });
          tree.size([h, w]);


    var toolTip = d3.select(document.getElementById("toolTip"));
    var header = d3.select(document.getElementById("head"));
    var header1 = d3.select(document.getElementById("header1"));
    var header2 = d3.select(document.getElementById("header2"));

    var columnOne = d3.select(document.getElementById("columnOne"));
    var columnTwo = d3.select(document.getElementById("columnTwo"));
    var columnThree = d3.select(document.getElementById("columnThree"));

    var buttonA=d3.select(document.getElementById("buttonA"));
    var buttonB=d3.select(document.getElementById("buttonB"));
    var buttonC=d3.select(document.getElementById("buttonC"));
    var buttonD=d3.select(document.getElementById("buttonD"));
    var buttonE=d3.select(document.getElementById("buttonE"));

    var divOne=d3.select(document.getElementById("divOne"));
    var divTwo=d3.select(document.getElementById("divTwo"));
    var divThree=d3.select(document.getElementById("divThree"));


    var diagonal = d3.svg.diagonal()
            .projection(function(d) { return [d.y, d.x]; });

    var vis = d3.select("#chart").append("svg:svg")
            .attr("width", w + m[1] + m[3])
            .attr("height", h + m[0] + m[2])
            .append("svg:g")
            .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

    var level1Max=0;
    var level2Max=0;
    var level3Max=0;
    var level4Max=0;

    var level1Radius;
    var level2Radius;
    var level3Radius;
    var level4Radius;

    var alreadySummed=false;

    var formatNumber = d3.format(",.3f");
    var formatCurrency = function(d) { return "$" + formatNumber(d) + " Billion" };


    d3.csv("jssystemsII.csv", function(csv) {


        //Category > Value Stream > Project > Production Order

        var nest = d3.nest()
                .key(function(d) { 
                    return d.Level1; 
                })
                .key(function(d) { 
                    return d.Level2; 
                })
                .key(function(d) { 
                    return d.Level3; 
                })
                .entries(csv);

        root={};
        root.values=nest;
        root.x0 = h / 2;
        root.y0 = 0;

        //rollup(root.values);

        var nodes = tree.nodes(root).reverse();

        tree.children(function (d){                                       //UPDATE-CHILDREN-TO-.children, NOT .values-.
            return d.children;
        });

        setup();

        alreadySummed=true;

        // Initialize the display to show a few nodes.
        root.values.forEach(toggleAll);
        //toggle(root.values[0]);                                           //OPEN-DATA-BRANCH-.

        update(root);


        buttonE.on("click",function (d) {
            buttonE.attr("class","selected")
            buttonA.attr("class",null);
            buttonB.attr("class",null);
            buttonC.attr("class",null);
            buttonD.attr("class",null);
            divOne.attr("class","selected")
            divTwo.attr("class",null);
            divThree.attr("class",null);
            fieldOne="columnDataFive";
            setup();
            update(root);
        });
        buttonD.on("click",function (d) {
            buttonD.attr("class","selected")
            buttonA.attr("class",null);
            buttonB.attr("class",null);
            buttonC.attr("class",null);
            buttonE.attr("class",null);
            divOne.attr("class","selected")
            divTwo.attr("class",null);
            divThree.attr("class",null);
            fieldOne="columnDataFour";
            setup();
            update(root);
        });
        buttonC.on("click",function (d) {
            buttonC.attr("class","selected")
            buttonB.attr("class",null);
            buttonA.attr("class",null);
            buttonD.attr("class",null);
            buttonE.attr("class",null);
            divThree.attr("class","selected")
            divOne.attr("class",null);
            divTwo.attr("class",null);
            fieldOne="columnDataThree";
            //fieldTwo="columnDataThree";
            setup();
            update(root);
        });
        buttonB.on("click",function (d) {
            buttonB.attr("class","selected")
            buttonA.attr("class",null);
            buttonC.attr("class",null);
            buttonD.attr("class",null);
            buttonE.attr("class",null);
            divTwo.attr("class","selected")
            divOne.attr("class",null);
            divThree.attr("class",null);
            fieldOne="columnDataTwo";
            //fieldTwo="columnDataTwo";
            setup();
            update(root);
        });
        buttonA.on("click",function (d) {
            buttonA.attr("class","selected")
            buttonB.attr("class",null);
            buttonC.attr("class",null);
            buttonD.attr("class",null);
            buttonE.attr("class",null);
            divOne.attr("class","selected")
            divTwo.attr("class",null);
            divThree.attr("class",null);
            fieldOne="columnDataOne";
            setup();
            update(root);
        });


        function setup() {

            level1Max=0;
            level2Max=0;
            level3Max=0;
            level4Max=0;

            for (var i=0; i < nodes.length; i++) {
                var node=nodes[i];
                rollup(node);
            }

                                                     //SET-LEVEL-RADIUS-.1

            level1Radius=d3.scale.sqrt()
                    .domain([0, level1Max])
                    .range([1,40]);

            level2Radius=d3.scale.sqrt()
                    .domain([0, level2Max])
                    .range([1,40]);

            level3Radius=d3.scale.sqrt()
                    .domain([0, level3Max])
                    .range([1,40]);

            level4Radius=d3.scale.sqrt()
                    .domain([0, level4Max])
                    .range([1,40]);

        }

        function rollup(node) {
            for (var i=0;i<dataFields.length;i++) {

                var dataField_name=dataFields[i];
                if (alreadySummed == false) {
                    var sum = (node[dataField_name] == undefined) ? node["column" + dataField_name] : Number(node[dataField_name]);
                    if (node[dataField_name] != undefined) node["column" + dataField_name]=sum;
                    if (node.parent) {
                        if (node.parent["column" + dataField_name]) {
                            node.parent["column" + dataField_name]+=sum;
                        }
                        else {
                            node.parent["column" + dataField_name]=sum;
                        }
                    }
                }

                if ((node.parent) && (fieldOne == "column" + dataField_name)) {
                    if (node.depth==1) {
                        level1Max=Math.max(level1Max,node["column" + dataField_name]);
                    }
                    else if (node.depth==2) {
                        level2Max=Math.max(level2Max,node["column" + dataField_name]);
                    }
                    else if (node.depth==3) {
                        level3Max=Math.max(level3Max,node["column" + dataField_name]);
                    }
                    else if (node.depth==4) {
                        level4Max=Math.max(level4Max,node["column" + dataField_name]);
                    }
                }
            }

            if (node.parent) {
                rollup(node.parent);
                setSourceFields(node,node.parent);
            }





            function setSourceFields(child,parent) {
                if (parent) {
                    for (var i=0; i < sourceFields.length; i++) {
                        var sourceField=sourceFields[i];
                        if (child[sourceField] != undefined) {
                            child["source_" + sourceField] = child[sourceField];
                        }
                        parent["source_" + sourceField] = (child["source_" + sourceField]) ? child["source_" + sourceField] : child[sourceField];
                    }
                }

            }

        }


        function toggleAll(d) {                               // RECURSIVELY - ITERATE - DATA- VIA - NAMED CALLBACK PARAMETER -.
            if (d.values && d.values.actuals) {
                d.values.actuals.forEach(toggleAll);
                toggle(d);
            }
            else if (d.values) {
                d.values.forEach(toggleAll);
                toggle(d);
            }
        }


    });

    function update(source) {

        var duration = d3.event && d3.event.altKey ? 5000 : 500;

        var nodes = tree.nodes(root).reverse();

        var depthCounter=0;

        // Iterate-Data-.
        nodes.forEach(function(d) {
            d.y = d.depth * 180;                                      //Set Level Y pos-.
            d.numChildren=(d.children) ? d.children.length : 0;          //Set Number of Children...

            if (d.depth==1) {     
                var color_selector =  (depthCounter % (colors.length-1))                                        //If trunk level
                d.linkColor=colors[color_selector];               //Set-Color-.
                //d.linkColor=colors[(depthCounter % (colors.length-1))];               //Set-Color-.
                //d.linkColor=colors[depthCounter];               //Set-Color-.
                depthCounter++;
            }

            if (d.numChildren==0 && d._children) d.numChildren= d._children.length;  //morechildren

        });


        nodes.forEach(function (d) {
            var obj=d;

            while ((obj.source && obj.source.depth > 1) || obj.depth > 1) {
                obj=(obj.source) ? obj.source.parent : obj.parent;                  //more parents
            }

            d.linkColor=(obj.source) ? obj.source.linkColor : obj.linkColor;          //Link-Color-.

        });



        // Update the nodes…
        var node = vis.selectAll("g.node")
                .data(nodes, function(d) { 
                    return d.id || (d.id = ++i); 
                });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("svg:g")
                .attr("class", "node")
                .attr("transform", function(d) {
                    return "translate(" + source.y0 + "," + source.x0 + ")";
                })
                .on("click", function(d) {                                           //Click-Handler-.
                    //check to see if kids are all blank.
                    var realNode = false;
                    d.values.forEach(function (d){
                        if(d.key!='') {                                          // hide blank nodes-.
                            realNode = true;
                            return false;
                        }  
                    });

                    if(realNode){
                        toggle(d);
                        update(d);
                    }

                });


            //Write-Trunk-Circle-Nodes
            nodeEnter.append("svg:circle")                                     //CIRCLE-.Animation
                    .attr("r", 1e-6)
                    .on("mouseover", function(d) { node_onMouseOver(d);})
                    .on("mouseout", function(d) {							// when the mouse leaves a circle, do the following
                        toolTip.transition()									// declare the transition properties to fade-out the div
                                .duration(500)									// it shall take 500ms
                                .style("opacity", "0");							// and go all the way to an opacity of nil
                    })
                    .style("fill", function(d) { return d.source ? d.source.linkColor: d.linkColor;
                    })
                    .style("fill-opacity", ".8")
                    .style("stroke", function(d) { return d.source ? d.source.linkColor: d.linkColor;
                        });

            //Write-All-Text-Nodes
            nodeEnter.append("svg:text")
                    .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
                    .attr("dy", ".35em")
                    .attr("text-anchor",
                    function(d) {
                        return d.children || d._children ? "end" : "start";
                    })
                    .text(function(d) {
                        var ret= (d.depth==4) ? d.Level4 : d.key;
                        ret = (String(ret).length > 25) ? String(ret).substr(0,22)  + "..." : ret;     //adds ellipses
                        ret = (d.depth==0) ? 'JSSystems II' : ret;                                    //ADD-ROOT-NODE-TITLE-.
                        return ret;
                    })
                    .on("mouseover", function(d) { node_onMouseOver(d);})
                    .on("mouseout", function(d) {							// when the mouse leaves a circle, do the following
                        toolTip.transition()									// declare the transition properties to fade-out the div
                                .duration(500)									// it shall take 500ms
                                .style("opacity", "0");							// and go all the way to an opacity of nil
                    })
                    .style("fill-opacity", "0");


        // Transition nodes to their new position.                       //Animate
        var nodeUpdate = node.transition()
                .duration(duration)
                .attr("transform", function(d) {
                    return "translate(" + d.y + "," + d.x + ")";
                });

        nodeUpdate.select("circle")
                .attr("r", function (d) {

                        if (d.depth==0) {                                 //default size for trunk - in px.                            
                            return 5;
                        }
                        //return 30;
                        //var dataRadius = d.values[0].values[0]["columnDataOne"];
                        //return dataRadius;
                        
                        else if (d.depth==1) {                              //CALL-Level - RADIUS - FACTORY-.
                            var ret = level1Radius(d[fieldOne]);
                            return (isNaN(ret) ? 2 : ret);
                        }
                        else if (d.depth==2) {
                            var ret = level2Radius(d[fieldOne]);
                            return (isNaN(ret) ? 2 : ret);
                        }
                        else if (d.depth==3) {
                            var ret = level3Radius(d[fieldOne]);
                            return (isNaN(ret) ? 2 : ret);
                        }
                        else if (d.depth==4) {
                            var ret = level4Radius(d[fieldOne]);
                            return (isNaN(ret) ? 2 : ret);
                        }
                        

                })
                .style("fill", function(d) { return d.source ? d.source.linkColor: d.linkColor})
                .style("fill-opacity",  function(d) {
                    var ret = ((d.depth+1)/5);
                    return ret; });




        nodeUpdate.select("text")
                .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
                .duration(duration)
                .attr("transform", function(d) {
                    return "translate(" + source.y + "," + source.x + ")";
                })
                .remove();

        nodeExit.select("circle")
                .attr("r", 1e-6);

        nodeExit.select("text")
                .style("fill-opacity", 1e-6);

        // Update the links…
        var link = vis.selectAll("path.link")
                .data(tree.links(nodes), function(d) {
                    return d.target.id;
                });

        var rootCounter=0;

        // Enter any new links at the parent's previous position.
        link.enter().insert("svg:path", "g")
                .attr("class", "link")
                .attr("d", function(d) {
                    if (Number(d.target[fieldOne]) > 0) {
                        var o = {x: source.x0, y: source.y0};
                        return diagonal({source: o, target: o});
                    }
                    else {
                        null;
                    }
                })
                .style("stroke",function (d,i) {
                    if (d.source.depth==0) {
                        rootCounter++;
                        return (d.source.children[rootCounter-1].linkColor);
                    }
                    else {
                        return (d.source) ? d.source.linkColor : d.linkColor;
                    }
                })
                .style("stroke-width", function (d,i) {
                                                                           //GET-RADIUS2
                    if (d.source.depth==0) {
                        var ret = level1Radius(d.target[fieldOne]) * 2;
                        return (isNaN(ret) ? 4 : ret);
                    }
                    else if (d.source.depth==1) {
                        var ret = level2Radius(d.target[fieldOne]) * 2;
                        return (isNaN(ret) ? 4 : ret);
                    }
                    else if (d.source.depth==2) {
                        var ret = level3Radius(d.target[fieldOne]) * 2;
                        return (isNaN(ret) ? 4 : ret);
                    }
                    else if (d.source.depth==3) {
                        var ret = level4Radius(d.target[fieldOne]) * 2;
                        return (isNaN(ret) ? 4 : ret);
                    }
                 })
                .style("stroke-opacity", function(d){
                    var ret = ((d.source.depth+1)/4.5)
                    if (d.target[fieldOne] <= 0) ret=0;
                    return ret;
                })
                .style("stroke-linecap","round")
                .transition()
                .duration(duration);
          //      .attr("d", diagonal);


        // Transition links to their new position.
         var linkUpdate = link.transition()
                .duration(duration)
                .attr("d", diagonal);

         linkUpdate                                                            
                 .style("stroke-width", function (d,i) {                          //GET-RADIUS3
                     if (d.source.depth==0) {
                         var ret = level1Radius(Number(d.target[fieldOne])) * 2;
                         return (isNaN(ret) ? 4 : ret);
                     }
                     else if (d.source.depth==1) {
                         var ret = level2Radius(Number(d.target[fieldOne])) * 2;
                         return (isNaN(ret) ? 4 : ret);
                     }
                     else if (d.source.depth==2) {
                         var ret = level3Radius(Number(d.target[fieldOne])) * 2;
                         return (isNaN(ret) ? 4 : ret);
                     }
                     else if (d.source.depth==3) {
                         var ret = level4Radius(Number(d.target[fieldOne])) * 2;
                         return (isNaN(ret) ? 4 : ret);
                     }
                })
             //    .style("stroke-dasharray", function(d) {
             //       var ret=(d.target[fieldOne] > 0) ? "" : "5,8";
             //       return ret;
             //    })
                 .style("stroke-opacity", function(d){
                     var ret = ((d.source.depth+1)/4.5)
                     if (d.target[fieldOne] <= 0) ret=0;
                     return ret;
                 })


        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
                .duration(duration)
                .attr("d", diagonal)
                .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });


        function node_onMouseOver(d) {
            toolTip.transition()
                    .duration(200)
                    .style("opacity", ".9");
            header.text(d["source_Level1"]);
            header1.text((d.depth > 1) ? d["source_Level2"] : "");
            header2.html((d.depth > 2) ? d["source_Level3"] : "");
            if (d.depth > 3) header2.html(header2.html() + " - "  + d["source_Level4"]);

            //!columnOne.text(formatCurrency(d["columnDataOne"]));                                //format data columns-.

            //!columnTwo.text(formatCurrency(d["columnDataTwo"]));

            //columnThree.text(formatCurrency(d["columnDataThree"]));

            toolTip.style("right", (170/*d3.event.pageX+15*/) + "px")                              //SET-TOOLTIP-.
                    .style("top", (/*140*/d3.event.pageY-75) + "px");
        }




    }

/*
    function toggleButton(button) {
        button.attr("class","selected");
        if (button == buttonA) {
            buttonC.attr("class","unselected");
            buttonB.attr("class","unselected");
        }
        else if (button == buttonB) {
            buttonC.attr("class","unselected");
            buttonA.attr("class","unselected");
        }
        else {
            buttonA.attr("class","unselected");
            buttonB.attr("class","unselected");
        }
    }
*/

        // Toggle children. //MOVE-THEM-TO-_-values of _children.
    function toggle(d) {
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
    }



</script>



</body></html>